services:
  pomerium:
    image: pomerium/pomerium:v0.27.0
    command: ["--config=/etc/pomerium/config.yaml"]
    volumes:
      - "{{ william_pomerium_dir }}/config.yaml:/etc/pomerium/config.yaml:ro"
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - frontend
      - admin-frontend
    restart: unless-stopped

  frontend:
    image: "{{ frontend_image }}"
    environment:
      NEXT_PUBLIC_WILLIAM_API_BASE_URL: "{{ frontend_api_public_url }}"
    restart: unless-stopped

  admin-frontend:
    image: "{{ admin_frontend_image }}"
    environment:
      NEXT_PUBLIC_WILLIAM_ADMIN_API_BASE_URL: "{{ admin_api_public_url }}"
    restart: unless-stopped

  server:
    image: "{{ william_server_image }}"
    command: ["/app/william-server"]
    environment:
      WILLIAM_ADDR: "{{ william_addr }}"
      WILLIAM_DB_DSN: "{{ william_db_dsn }}"
      WILLIAM_MIGRATIONS: "{{ william_migrations_source }}"
    ports:
      - "8080:8080"
    depends_on:
      - postgres
    restart: unless-stopped

  admin-server:
    image: "{{ william_admin_server_image }}"
    command: ["/app/admin-server"]
    environment:
      WILLIAM_ADMIN_ADDR: "{{ william_admin_addr }}"
      WILLIAM_DB_DSN: "{{ william_db_dsn }}"
      WILLIAM_MIGRATIONS: "{{ william_migrations_source }}"
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    privileged: true
    volumes:
      - "{{ william_wireguard_dir }}:/etc/wireguard"
      - "/lib/modules:/lib/modules:ro"
    ports:
      - "8081:8081"
    depends_on:
      - postgres
    restart: unless-stopped

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: "{{ postgres_db }}"
      POSTGRES_USER: "{{ postgres_user }}"
      POSTGRES_PASSWORD: "{{ postgres_password }}"
    volumes:
      - "{{ william_postgres_dir }}:/var/lib/postgresql/data"
    restart: unless-stopped
